<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Liferay User Importer</title>
    <style>
        :root {
            --primary: #0b74de;
            --primary-dark: #095fb8;
            --surface: #ffffff;
            --border: #e5e7eb;
            --muted: #6b7280;
            --success: #0f9d58;
            --error: #d1434b;
            --background: linear-gradient(120deg, #f5f7fb 0%, #eef2f7 100%);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
            margin: 0;
            min-height: 100vh;
            background: var(--background);
            color: #111827;
        }

        .page {
            max-width: 1100px;
            margin: 0 auto;
            padding: 32px 20px 48px;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 20px;
        }

        h1 {
            margin: 0;
            font-size: 26px;
            letter-spacing: -0.5px;
        }

        .subtitle {
            margin: 4px 0 0;
            color: var(--muted);
            font-size: 14px;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 18px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.07);
        }

        .card h3 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 18px;
            letter-spacing: -0.25px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 14px;
        }

        .form-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            margin-top: 12px;
        }

        input[type="text"],
        select,
        input[type="file"] {
            width: 100%;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #f8fafc;
            font-size: 14px;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        input[type="text"]:focus,
        select:focus,
        input[type="file"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(11, 116, 222, 0.15);
        }

        button {
            margin-top: 6px;
            padding: 12px 18px;
            background: var(--primary);
            color: white;
            font-weight: 700;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.2s ease, background 0.15s ease;
            box-shadow: 0 10px 20px rgba(11, 116, 222, 0.25);
        }

        button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 12px 22px rgba(11, 116, 222, 0.3);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 8px 16px rgba(11, 116, 222, 0.24);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            border-radius: 10px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid var(--border);
            padding: 10px 12px;
            font-size: 14px;
            text-align: left;
        }

        th {
            background: #eef2f7;
            font-weight: 700;
        }

        tbody tr:nth-child(odd) {
            background: #fbfdff;
        }

        .status {
            margin-top: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            background: #f1f5f9;
            color: var(--muted);
            font-weight: 600;
            border: 1px solid var(--border);
        }

        .search-results {
            position: relative;
        }

        .search-results:not(.hidden) {
            margin-top: 6px;
        }

        .search-results__list {
            position: absolute;
            top: calc(100% + 2px);
            left: 0;
            z-index: 10;
            width: 100%;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.12);
            max-height: 220px;
            overflow-y: auto;
            padding: 6px 0;
            list-style: none;
            margin: 0;
        }

        .search-results__item {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }

        .search-results__id {
            color: var(--muted);
            font-size: 12px;
        }

        .search-results__item:hover,
        .search-results__item:focus {
            background: #f3f6fb;
        }

        .search-results__empty {
            padding: 10px 12px;
            color: var(--muted);
            font-size: 13px;
        }

        .hidden { display: none; }
        .error { background: #fff2f3; color: var(--error); border-color: #f7c9cd; }
        .success { background: #ecf9f2; color: var(--success); border-color: #bce5cd; }

        .section-title {
            margin-bottom: 4px;
            color: var(--muted);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }
    </style>
</head>
<body>
<div class="page">
    <header>
        <div>
            <h1>Liferay User Importer</h1>
            <p class="subtitle">Upload a spreadsheet and keep organizations in sync effortlessly.</p>
        </div>
    </header>

    <div class="card">
        <div class="section-title">Upload details</div>
        <div class="form-grid">
            <div>
                <label for="search">Search organizations</label>
                <input type="text" id="search" placeholder="Start typing to filter organizations" autocomplete="off">
                <div id="searchResults" class="search-results hidden"></div>
            </div>
            <div>
                <label for="organization">Organization</label>
                <select id="organization"></select>
            </div>
            <div>
                <label for="file">Excel (.xlsx) file</label>
                <input type="file" id="file" accept=".xlsx">
            </div>
        </div>
        <button id="upload">Upload and Import</button>
        <div id="status" class="status"></div>
    </div>

    <div class="card">
        <div class="section-title">Import results</div>
        <h3>Validation Errors</h3>
        <table id="validationTable" class="hidden">
            <thead><tr><th>Row</th><th>Message</th><th>Email</th><th>Name</th><th>Surname</th></tr></thead>
            <tbody></tbody>
        </table>
        <h3>Row Failures</h3>
        <table id="failuresTable" class="hidden">
            <thead><tr><th>Row</th><th>Message</th></tr></thead>
            <tbody></tbody>
        </table>
        <h3>Imported Users</h3>
        <table id="importedTable" class="hidden">
            <thead><tr><th>Email</th><th>Name</th><th>Surname</th><th>Created</th></tr></thead>
            <tbody></tbody>
        </table>
        <h3>Existing Users</h3>
        <table id="existingTable" class="hidden">
            <thead><tr><th>Email</th><th>Name</th><th>Surname</th><th>Created</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<script>
    const organizationSelect = document.getElementById('organization');
    const searchInput = document.getElementById('search');
    const searchResults = document.getElementById('searchResults');
    let organizations = [];

    function renderOrganizations(filter = '') {
        const previousValue = organizationSelect.value;
        organizationSelect.innerHTML = '';

        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = '';
        organizationSelect.appendChild(emptyOption);

        const filteredOrganizations = organizations.filter(org =>
            org.name.toLowerCase().includes(filter.toLowerCase())
        );

        filteredOrganizations.forEach(org => {
            const option = document.createElement('option');
            option.value = org.organizationId;
            option.textContent = `${org.name} (${org.organizationId})`;
            organizationSelect.appendChild(option);
        });

        const selectedStillExists = filteredOrganizations.some(
            org => String(org.organizationId) === previousValue
        );

        organizationSelect.value = selectedStillExists ? previousValue : '';
    }

    function renderSearchResults(filter = '') {
        searchResults.innerHTML = '';

        const trimmedFilter = filter.trim().toLowerCase();
        if (!trimmedFilter) {
            searchResults.classList.add('hidden');
            return;
        }

        const filteredOrganizations = organizations.filter(org =>
            org.name.toLowerCase().includes(trimmedFilter)
        );

        const list = document.createElement('ul');
        list.className = 'search-results__list';

        if (!filteredOrganizations.length) {
            const empty = document.createElement('li');
            empty.className = 'search-results__empty';
            empty.textContent = 'No matching organizations found';
            list.appendChild(empty);
        } else {
            filteredOrganizations.forEach(org => {
                const item = document.createElement('li');
                item.className = 'search-results__item';
                item.tabIndex = 0;
                item.innerHTML = `<span>${org.name}</span><span class="search-results__id">${org.organizationId}</span>`;

                const selectOrganization = () => {
                    searchInput.value = org.name;
                    renderOrganizations(org.name);
                    organizationSelect.value = String(org.organizationId);
                    searchResults.classList.add('hidden');
                };

                item.addEventListener('click', selectOrganization);
                item.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        selectOrganization();
                    }
                });

                list.appendChild(item);
            });
        }

        searchResults.appendChild(list);
        searchResults.classList.remove('hidden');
    }

    function loadOrganizations() {
        fetch('/api/users/organizations')
            .then(r => r.json())
            .then(data => {
                organizations = data;
                const currentFilter = searchInput.value;
                renderOrganizations(currentFilter);
                if (currentFilter) {
                    renderSearchResults(currentFilter);
                }
            })
            .catch(() => {
                document.getElementById('status').textContent = 'Failed to load organizations';
                document.getElementById('status').className = 'status error';
            });
    }

    searchInput.addEventListener('input', () => {
        const value = searchInput.value;
        renderOrganizations(value);
        renderSearchResults(value);
    });

    searchInput.addEventListener('focus', () => {
        if (searchInput.value) {
            renderSearchResults(searchInput.value);
        }
    });

    searchInput.addEventListener('blur', () => {
        setTimeout(() => searchResults.classList.add('hidden'), 150);
    });

    document.getElementById('upload').addEventListener('click', () => {
        const fileInput = document.getElementById('file');
        const organizationId = organizationSelect.value;
        const status = document.getElementById('status');
        status.textContent = '';
        status.className = 'status';

        if (!organizationId) {
            status.textContent = 'Please choose an organization first';
            status.classList.add('error');
            return;
        }
        if (!fileInput.files.length) {
            status.textContent = 'Please choose a file to upload';
            status.classList.add('error');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('organizationId', organizationId);

        status.textContent = 'Importing...';
        status.className = 'status';

        fetch('/api/users/import', {
            method: 'POST',
            body: formData
        })
            .then(r => r.json())
            .then(showResult)
            .catch(() => {
                status.textContent = 'Import failed';
                status.className = 'status error';
            });
    });

    function showResult(result) {
        const status = document.getElementById('status');
        status.textContent = `Processed ${result.totalRows} rows. Imported: ${result.importedCount}, Existing: ${result.existingCount}, Failed: ${result.failedCount}`;
        status.className = 'status success';

        renderValidationErrors(result.validationErrors, document.getElementById('validationTable'));
        renderTable(result.rowFailures, document.getElementById('failuresTable'));
        renderTable(result.importedUsers, document.getElementById('importedTable'));
        renderTable(result.existingUsers, document.getElementById('existingTable'));
    }

    function renderValidationErrors(items, table) {
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';
        if (!items || !items.length) {
            table.classList.add('hidden');
            return;
        }
        table.classList.remove('hidden');
        items.forEach(item => {
            const tr = document.createElement('tr');
            const rowNumber = item.rowNumber ?? '';
            const email = item.email || '';
            const name = item.name || '';
            const surname = item.surname || '';
            tr.innerHTML = `<td>${rowNumber}</td><td>${item.message}</td><td>${email}</td><td>${name}</td><td>${surname}</td>`;
            tbody.appendChild(tr);
        });
    }

    function formatDateTime(value) {
        if (!value) return '';

        const maybeZoned = typeof value === 'object' && 'year' in value
            ? new Date(
                value.year,
                (value.month ?? 1) - 1,
                value.day ?? 1,
                value.hour ?? 0,
                value.minute ?? 0,
                value.second ?? 0
            )
            : new Date(value);

        if (isNaN(maybeZoned)) {
            return '';
        }

        const pad = (num) => String(num).padStart(2, '0');

        return `${maybeZoned.getFullYear()}-${pad(maybeZoned.getMonth() + 1)}-${pad(maybeZoned.getDate())}` +
            ` ${pad(maybeZoned.getHours())}:${pad(maybeZoned.getMinutes())}:${pad(maybeZoned.getSeconds())}`;
    }

    function renderTable(items, table) {
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';
        if (!items || !items.length) {
            table.classList.add('hidden');
            return;
        }
        table.classList.remove('hidden');
        items.forEach(item => {
            const tr = document.createElement('tr');
            if (item.rowNumber) {
                tr.innerHTML = `<td>${item.rowNumber}</td><td>${item.message}</td>`;
            } else {
                const createdDate = formatDateTime(item.createdDate);
                tr.innerHTML = `<td>${item.email}</td><td>${item.name}</td><td>${item.surname}</td><td>${createdDate}</td>`;
            }
            tbody.appendChild(tr);
        });
    }

    loadOrganizations();
</script>
</body>
</html>
