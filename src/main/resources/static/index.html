<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Liferay User Importer</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .card { border: 1px solid #ccc; padding: 16px; border-radius: 4px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #f5f5f5; }
        .status { margin-top: 10px; }
        .hidden { display: none; }
        .error { color: #b00020; }
        .success { color: #006400; }
        input[type="text"] { width: 100%; padding: 6px; }
    </style>
</head>
<body>
<div class="container">
    <h1>Liferay User Importer</h1>
    <div class="card">
        <label for="search">Search organizations</label>
        <input type="text" id="search" placeholder="Start typing to filter organizations">
        <label for="organization">Organization</label>
        <select id="organization"></select>
        <label for="file">Excel (.xlsx) file</label>
        <input type="file" id="file" accept=".xlsx">
        <button id="upload">Upload and Import</button>
        <div id="status" class="status"></div>
    </div>

    <div class="card">
        <h3>Validation Errors</h3>
        <table id="validationTable" class="hidden">
            <thead><tr><th>Row</th><th>Message</th><th>Email</th><th>Name</th><th>Surname</th></tr></thead>
            <tbody></tbody>
        </table>
        <h3>Row Failures</h3>
        <table id="failuresTable" class="hidden">
            <thead><tr><th>Row</th><th>Message</th></tr></thead>
            <tbody></tbody>
        </table>
        <h3>Imported Users</h3>
        <table id="importedTable" class="hidden">
            <thead><tr><th>Email</th><th>Name</th><th>Surname</th></tr></thead>
            <tbody></tbody>
        </table>
        <h3>Existing Users</h3>
        <table id="existingTable" class="hidden">
            <thead><tr><th>Email</th><th>Name</th><th>Surname</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<script>
    const organizationSelect = document.getElementById('organization');
    const searchInput = document.getElementById('search');
    let organizations = [];

    function renderOrganizations(filter = '') {
        organizationSelect.innerHTML = '';
        organizations
            .filter(org => org.name.toLowerCase().includes(filter.toLowerCase()))
            .forEach(org => {
                const option = document.createElement('option');
                option.value = org.organizationId;
                option.textContent = `${org.name} (${org.organizationId})`;
                organizationSelect.appendChild(option);
            });
    }

    function loadOrganizations() {
        fetch('/api/users/organizations')
            .then(r => r.json())
            .then(data => {
                organizations = data;
                renderOrganizations();
            })
            .catch(() => {
                document.getElementById('status').textContent = 'Failed to load organizations';
                document.getElementById('status').className = 'status error';
            });
    }

    searchInput.addEventListener('input', () => renderOrganizations(searchInput.value));

    document.getElementById('upload').addEventListener('click', () => {
        const fileInput = document.getElementById('file');
        const organizationId = organizationSelect.value;
        const status = document.getElementById('status');
        status.textContent = '';
        status.className = 'status';

        if (!organizationId) {
            status.textContent = 'Please choose an organization first';
            status.classList.add('error');
            return;
        }
        if (!fileInput.files.length) {
            status.textContent = 'Please choose a file to upload';
            status.classList.add('error');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('organizationId', organizationId);

        status.textContent = 'Importing...';
        status.className = 'status';

        fetch('/api/users/import', {
            method: 'POST',
            body: formData
        })
            .then(r => r.json())
            .then(showResult)
            .catch(() => {
                status.textContent = 'Import failed';
                status.className = 'status error';
            });
    });

    function showResult(result) {
        const status = document.getElementById('status');
        status.textContent = `Processed ${result.totalRows} rows. Imported: ${result.importedCount}, Existing: ${result.existingCount}, Failed: ${result.failedCount}`;
        status.className = 'status success';

        renderValidationErrors(result.validationErrors, document.getElementById('validationTable'));
        renderTable(result.rowFailures, document.getElementById('failuresTable'));
        renderTable(result.importedUsers, document.getElementById('importedTable'));
        renderTable(result.existingUsers, document.getElementById('existingTable'));
    }

    function renderValidationErrors(items, table) {
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';
        if (!items || !items.length) {
            table.classList.add('hidden');
            return;
        }
        table.classList.remove('hidden');
        items.forEach(item => {
            const tr = document.createElement('tr');
            const rowNumber = item.rowNumber ?? '';
            const email = item.email || '';
            const name = item.name || '';
            const surname = item.surname || '';
            tr.innerHTML = `<td>${rowNumber}</td><td>${item.message}</td><td>${email}</td><td>${name}</td><td>${surname}</td>`;
            tbody.appendChild(tr);
        });
    }

    function renderTable(items, table) {
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';
        if (!items || !items.length) {
            table.classList.add('hidden');
            return;
        }
        table.classList.remove('hidden');
        items.forEach(item => {
            const tr = document.createElement('tr');
            if (item.rowNumber) {
                tr.innerHTML = `<td>${item.rowNumber}</td><td>${item.message}</td>`;
            } else {
                tr.innerHTML = `<td>${item.email}</td><td>${item.name}</td><td>${item.surname}</td>`;
            }
            tbody.appendChild(tr);
        });
    }

    loadOrganizations();
</script>
</body>
</html>
